<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç§‹æ‹›ç®¡ç†</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f9f9fb;
      color: #333;
      margin: 0;
      padding: 10px;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 24px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    /* ç´§å‡‘æ·»åŠ è¡¨å• */
    .add-form {
      display: flex;
      gap: 6px;
      align-items: center;
      padding: 10px;
      background: #f0f5ff;
      border-radius: 6px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .add-form label {
      font-weight: 500;
      width: 50px;
      text-align: right;
    }
    .add-form input {
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
      width: 120px;
    }
    button.add {
      background-color: #27ae60;
      color: white;
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    /* æ“ä½œæŒ‰é’®åŒº */
    .action-buttons {
      text-align: right;
      margin-bottom: 10px;
    }
    button.export {
      background-color: #6f42c1;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      margin-left: 8px;
    }
    button.export:nth-child(1) {
      background-color: #2c3e50;
    }

    /* è¡¨æ ¼æ ·å¼ */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      /* å›ºå®šåˆ—å®½ */
      width: {{width}};
    }
    th {
      background-color: #f2f2f2;
      color: #2c3e50;
      font-weight: 500;
      position: relative;
      cursor: pointer;
    }
    .sort-btn {
      font-size: 12px;
      background: none;
      border: none;
      color: #888;
      opacity: 0.5;
      transition: opacity 0.2s, color 0.2s;
    }
    .sort-btn:hover {
      opacity: 1;
      color: #333;
    }

    /* å›ºå®šåˆ—å®½ï¼Œæº¢å‡ºå†…å®¹æ¨ªå‘æ»šåŠ¨ */
    td {
      position: relative;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: clip;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    /* å†…å®¹å¯æ¨ªå‘æ»šåŠ¨ */
    td:hover {
      overflow: auto;
      white-space: nowrap;
      background-color: #f8f9fd;
    }

    /* å¼ºåˆ¶å›ºå®šåˆ—å®½ */
    #tableBody td:nth-child(1) { width: 18%; }
    #tableBody td:nth-child(2) { width: 15%; }
    #tableBody td:nth-child(3) { width: 12%; }
    #tableBody td:nth-child(4) { width: 10%; }
    #tableBody td:nth-child(5) { width: 12%; }
    #tableBody td:nth-child(6) { width: 12%; }
    #tableBody td:nth-child(7) { width: 8%; }

    /* åˆ é™¤æŒ‰é’®åœ¨å›ºå®šåŒºåŸŸå†… */
    .delete-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      width: 100%;
      justify-content: center;
    }
    .delete-btn {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 10px;
      cursor: pointer;
    }
    /* æ‚¬åœæ—¶æŒ‰é’®å‡ºç°ï¼Œä½†ä¸æ”¹å˜å¸ƒå±€ */
    .delete-btn {
      opacity: 0;
      transition: opacity 0.2s;
    }
    .delete-wrapper:hover .delete-btn {
      opacity: 1;
    }

    select.inline {
      width: 100%;
      padding: 2px;
      font-size: 13px;
      border: 1px solid #999;
      border-radius: 3px;
    }
    .date-edit {
      display: flex;
      justify-content: center;
      gap: 4px;
      width: 100%;
    }
    .date-edit select {
      width: 45%;
      padding: 2px;
      font-size: 12px;
    }
    .priority-s { background-color: #ffebee; color: #c62828; font-weight: bold; }
    .priority-a { background-color: #fff8e1; color: #f57f17; font-weight: bold; }
    .priority-b { background-color: #e3f2fd; color: #1565c0; font-weight: bold; }
    .priority-c { background-color: #eeeeee; color: #424242; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ’¼ ç§‹æ‹›è¿›åº¦ç®¡ç†</h1>

    <!-- æ·»åŠ è¡¨å• -->
    <div class="add-form">
      <label>å…¬å¸</label>
      <input type="text" id="company" placeholder="è…¾è®¯" />

      <label>å²—ä½</label>
      <input type="text" id="position" placeholder="å‰ç«¯å¼€å‘" />

      <button class="add" onclick="addItem()">æ·»åŠ </button>
    </div>

    <!-- å¯¼å‡º & å¯¼å…¥ æŒ‰é’® -->
    <div class="action-buttons">
      <button class="export" onclick="exportToJson()">å¯¼å‡ºä¸º JSON</button>
      <button class="export" style="background-color: #2c3e50;" onclick="document.getElementById('importInput').click()">å¯¼å…¥ JSON</button>
      <input type="file"
             id="importInput"
             accept=".json"
             style="display: none;"
             onchange="importFromJson(event)" />
    </div>

    <!-- æ•°æ®è¡¨æ ¼ -->
    <table id="jobTable">
      <thead>
        <tr>
          <th style="width:18%">å…¬å¸<button class="sort-btn" onclick="sortByCompany()">ğŸ”½</button></th>
          <th style="width:15%">å²—ä½</th>
          <th style="width:12%">è¿›åº¦<button class="sort-btn" onclick="sortByStatus()">ğŸ”½</button></th>
          <th style="width:10%">é¢è¯•æ—¥<button class="sort-btn" onclick="sortByDate()">ğŸ”½</button></th>
          <th style="width:12%">è–ªèµ„</th>
          <th style="width:12%">Baseåœ°</th>
          <th style="width:8%">ä¼˜å…ˆçº§<button class="sort-btn" onclick="sortByPriority()">ğŸ”½</button></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    const STORAGE_KEY = 'jobApplications';

    // é¢è¯•è¿›åº¦é¡ºåº
    const STATUS_ORDER = {
      'ç®€å†': 0,
      'ç¬”è¯•': 1,
      'ä¸€é¢': 2,
      'äºŒé¢': 3,
      'ä¸‰é¢': 4,
      'å››é¢': 5,
      'äº”é¢': 6,
      'HRé¢': 7,
      'OC': 8,
      'è°ˆè–ª': 9,
      'æ‹’ç»': 99,
      'æ¥å—': 10
    };

    // é¡µé¢åŠ è½½
    document.addEventListener('DOMContentLoaded', renderTable);

    function getData() {
      const data = localStorage.getItem(STORAGE_KEY);
      return data ? JSON.parse(data) : [];
    }

    function saveData(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function generateKey(company, position) {
      return `${company.trim()}__${position.trim()}`;
    }

    // æ·»åŠ æ–°æ¡ç›®
    function addItem() {
      const company = id('company').value.trim();
      const position = id('position').value.trim();
      if (!company || !position) {
        alert('è¯·å¡«å†™å…¬å¸å’Œå²—ä½ï¼');
        return;
      }

      const key = generateKey(company, position);
      const data = getData();
      if (data.some(item => item.key === key)) {
        alert('è¯¥ å…¬å¸+å²—ä½ å·²å­˜åœ¨ï¼');
        return;
      }

      const newItem = {
        key,
        company,
        position,
        status: 'ç®€å†',
        interviewDate: '',
        salary: '',
        base: '',
        priority: 'B'
      };

      data.unshift(newItem);
      saveData(data);
      resetForm();
      renderTable();
    }

    function resetForm() {
      id('company').value = '';
      id('position').value = '';
    }

    // åˆ›å»ºå¯ç¼–è¾‘æ–‡æœ¬å•å…ƒæ ¼
    function createEditableTextCell(text, onSave) {
      const td = document.createElement('td');
      td.textContent = text || '';
      td.title = 'åŒå‡»å¯ç¼–è¾‘';

      td.ondblclick = function () {
        if (td.querySelector('input')) return;
        const input = document.createElement('input');
        input.type = 'text';
        input.value = td.textContent;
        input.style.width = '100%';
        input.style.padding = '2px';
        input.style.fontSize = '13px';

        td.textContent = '';
        td.appendChild(input);
        input.focus();

        const finish = () => {
          const value = input.value.trim();
          td.textContent = value;
          onSave(value);
        };

        input.onblur = finish;
        input.onkeydown = e => {
          if (e.key === 'Enter') input.blur();
          if (e.key === 'Escape') {
            td.textContent = text;
            finish();
          }
        };
      };

      return td;
    }

    // åˆ›å»ºä¸‹æ‹‰é€‰æ‹©å•å…ƒæ ¼
    function createEditableSelectCell(currentValue, options, onSave) {
      const td = document.createElement('td');
      td.textContent = currentValue || '';
      td.title = 'åŒå‡»å¯ç¼–è¾‘';

      td.ondblclick = function () {
        if (td.querySelector('select')) return;
        const select = document.createElement('select');
        select.className = 'inline';
        options.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt;
          option.textContent = opt;
          if (opt === currentValue) option.selected = true;
          select.appendChild(option);
        });

        td.textContent = '';
        td.appendChild(select);
        select.focus();

        select.onblur = () => {
          const value = select.value;
          td.textContent = value;
          onSave(value);
        };
        select.onchange = () => select.blur();
      };

      return td;
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable() {
      const tbody = id('tableBody');
      tbody.innerHTML = '';
      const data = getData();

      data.forEach(item => {
        const tr = document.createElement('tr');

        // å…¬å¸ + åˆ é™¤æŒ‰é’®ï¼ˆç•¥ï¼‰
        const tdCompany = document.createElement('td');
        const wrapper = document.createElement('div');
        wrapper.className = 'delete-wrapper';
        wrapper.textContent = item.company || '';
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Ã—';
        deleteBtn.className = 'delete-btn';
        deleteBtn.title = 'åˆ é™¤';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteItem(item.key);
        };
        wrapper.appendChild(deleteBtn);
        tdCompany.appendChild(wrapper);
        tdCompany.title = 'åŒå‡»å¯ç¼–è¾‘';

        tdCompany.ondblclick = function () {
          if (tdCompany.querySelector('input')) return;
          const input = document.createElement('input');
          input.type = 'text';
          input.value = item.company;
          input.style.width = '100%';
          input.style.padding = '2px';
          input.style.fontSize = '13px';

          const wrapper = tdCompany.querySelector('.delete-wrapper');
          const deleteBtn = wrapper.querySelector('.delete-btn');
          wrapper.removeChild(deleteBtn);
          wrapper.textContent = '';
          wrapper.appendChild(input);
          wrapper.appendChild(deleteBtn);
          deleteBtn.style.opacity = '0';
          input.focus();

          const finish = () => {
            const value = input.value.trim();
            wrapper.textContent = value || '';
            wrapper.appendChild(deleteBtn);
            deleteBtn.style.opacity = '';
            updateField(item.key, 'company', value);
          };

          input.onblur = finish;
          input.onkeydown = e => {
            if (e.key === 'Enter') input.blur();
            if (e.key === 'Escape') {
              wrapper.textContent = item.company;
              wrapper.appendChild(deleteBtn);
            }
          };
        };

        // å²—ä½ï¼ˆç•¥ï¼‰
        const tdPosition = createEditableTextCell(
          item.position,
          value => updateField(item.key, 'position', value)
        );

        // è¿›åº¦ï¼ˆç•¥ï¼‰
        const tdStatus = createEditableSelectCell(
          item.status,
          Object.keys(STATUS_ORDER).filter(s => !['æ‹’ç»', 'æ¥å—'].includes(s)),
          value => updateField(item.key, 'status', value)
        );

        // âœ… ä¿®å¤ç‰ˆï¼šé¢è¯•æ—¥ï¼ˆæœˆ+æ—¥åŒä¸‹æ‹‰ï¼Œå¯è¿ç»­é€‰æ‹©ï¼‰
        const tdDate = document.createElement('td');
        tdDate.textContent = item.interviewDate || 'æœªå®š';
        tdDate.title = 'åŒå‡»é€‰æ‹©æ—¥æœŸ';

        tdDate.ondblclick = function () {
          if (tdDate.querySelector('.date-edit') || tdDate.dataset.editing === 'true') return;

          const parts = item.interviewDate ? item.interviewDate.split('/') : [];
          const month = parts[0] || '';
          const day = parts[1] || '';

          const container = document.createElement('div');
          container.className = 'date-edit';
          container.dataset.editing = 'true';
          tdDate.dataset.editing = 'true';

          container.innerHTML = `
            <select class="month-select">
              <option value="">æœˆ</option>
              ${Array.from({length: 12}, (_, i) => {
                const mm = (i + 1).toString().padStart(2, '0');
                return `<option value="${mm}" ${mm === month ? 'selected' : ''}>${i + 1}æœˆ</option>`;
              }).join('')}
            </select>
            <select class="day-select">
              <option value="">æ—¥</option>
              ${Array.from({length: 31}, (_, i) => {
                const dd = (i + 1).toString().padStart(2, '0');
                return `<option value="${dd}" ${dd === day ? 'selected' : ''}>${i + 1}æ—¥</option>`;
              }).join('')}
            </select>
          `;

          const selectMonth = container.querySelector('.month-select');
          const selectDay = container.querySelector('.day-select');

          // âœ… ä¿å­˜å‡½æ•°
          const updateDate = () => {
            const m = selectMonth.value;
            const d = selectDay.value;
            if (m && d) {
              const dateStr = `${m}/${d}`;
              tdDate.textContent = dateStr;
              updateField(item.key, 'interviewDate', dateStr);
            } else {
              tdDate.textContent = 'æœªå®š';
            }
            // æ¸…ç†çŠ¶æ€
            delete tdDate.dataset.editing;
            if (container.parentNode) container.replaceWith(document.createTextNode(''));
          };

          // âœ… å»¶è¿Ÿ blur åˆ¤æ–­ï¼Œé˜²æ­¢å¿«é€Ÿåˆ‡æ¢ä¸‹æ‹‰ä¸¢å¤±
          selectMonth.onchange = () => selectDay.focus();
          selectDay.onchange = () => {}; // ä¸ç«‹å³ä¿å­˜

          // âœ… åªæœ‰æ•´ä¸ª container å¤±å»ç„¦ç‚¹æ—¶æ‰ä¿å­˜
          container.addEventListener('focusout', (e) => {
            // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿ç„¦ç‚¹æ˜¯å¦çœŸçš„ç¦»å¼€
            setTimeout(() => {
              if (!container.contains(document.activeElement)) {
                updateDate();
              }
            }, 10);
          });

          // æ’å…¥å¹¶èšç„¦
          tdDate.textContent = '';
          tdDate.appendChild(container);
          selectMonth.focus();
        };

        // è–ªèµ„ï¼ˆç•¥ï¼‰
        const tdSalary = createEditableTextCell(
          item.salary,
          value => updateField(item.key, 'salary', value)
        );

        // Baseåœ°ï¼ˆç•¥ï¼‰
        const tdBase = createEditableTextCell(
          item.base,
          value => updateField(item.key, 'base', value)
        );

        // ä¼˜å…ˆçº§ï¼ˆç•¥ï¼‰
        const tdPriority = createEditableSelectCell(
          item.priority,
          ['S', 'A', 'B', 'C'],
          value => {
            updateField(item.key, 'priority', value);
            applyPriorityStyle(tr, value);
          }
        );
        applyPriorityStyle(tr, item.priority);

        tr.append(tdCompany, tdPosition, tdStatus, tdDate, tdSalary, tdBase, tdPriority);
        tbody.appendChild(tr);
      });
    }

    // æ›´æ–°å­—æ®µ
    function updateField(key, field, value) {
      const data = getData();
      const index = data.findIndex(item => item.key === key);
      if (index === -1) return;

      const oldItem = data[index];
      const newItem = { ...oldItem, [field]: value };

      if (field === 'company' || field === 'position') {
        const newKey = generateKey(newItem.company, newItem.position);
        if (newKey !== key) {
          if (data.some((item, i) => i !== index && item.key === newKey)) {
            alert('è¯¥ å…¬å¸+å²—ä½ ç»„åˆå·²å­˜åœ¨ï¼');
            renderTable();
            return;
          }
          newItem.key = newKey;
        }
      }

      data[index] = newItem;
      saveData(data);
      renderTable();
    }

    // åˆ é™¤æ¡ç›®
    function deleteItem(key) {
      if (confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ')) {
        const data = getData().filter(item => item.key !== key);
        saveData(data);
        renderTable();
      }
    }

    // åº”ç”¨ä¼˜å…ˆçº§èƒŒæ™¯è‰²
    function applyPriorityStyle(tr, priority) {
      tr.className = '';
      if (priority === 'S') tr.classList.add('priority-s');
      else if (priority === 'A') tr.classList.add('priority-a');
      else if (priority === 'B') tr.classList.add('priority-b');
      else if (priority === 'C') tr.classList.add('priority-c');
    }

    // æ’åºå‡½æ•°
    function sortByCompany() {
      const data = getData().sort((a, b) => a.company.localeCompare(b.company));
      saveData(data);
      renderTable();
    }

    function sortByStatus() {
      const data = getData().sort((a, b) => {
        const sa = STATUS_ORDER[a.status] !== undefined ? STATUS_ORDER[a.status] : 99;
        const sb = STATUS_ORDER[b.status] !== undefined ? STATUS_ORDER[b.status] : 99;
        return sa - sb;
      });
      saveData(data);
      renderTable();
    }

    function sortByDate() {
      const parseDate = (dateStr) => {
        if (!dateStr || dateStr === 'æœªå®š') return 999999;
        const [mm, dd] = dateStr.split('/').map(Number);
        return mm * 100 + dd;
      };
      const data = getData().sort((a, b) => parseDate(a.interviewDate) - parseDate(b.interviewDate));
      saveData(data);
      renderTable();
    }

    function sortByPriority() {
      const order = { 'S': 0, 'A': 1, 'B': 2, 'C': 3 };
      const data = getData().sort((a, b) => order[a.priority] - order[b.priority]);
      saveData(data);
      renderTable();
    }

    // âœ… å¯¼å‡ºä¸º JSON æ–‡ä»¶
    function exportToJson() {
      const data = getData();
      const filename = 'job-applications.json';
      const jsonString = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // âœ… å¯¼å…¥ JSON æ–‡ä»¶
    function importFromJson(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);

          if (!Array.isArray(imported)) {
            alert('å¯¼å…¥çš„ JSON æ ¼å¼ä¸æ­£ç¡®ï¼šåº”ä¸ºæ•°ç»„');
            return;
          }

          const currentData = getData();
          const updatedData = [...currentData];
          let addCount = 0;
          let updateCount = 0;

          imported.forEach(item => {
            if (!item.company || !item.position) return;

            const key = generateKey(item.company, item.position);
            const existingIndex = updatedData.findIndex(i => i.key === key);

            const newItem = {
              key,
              company: item.company,
              position: item.position,
              status: item.status || 'ç®€å†',
              interviewDate: item.interviewDate || '',
              salary: item.salary || '',
              base: item.base || '',
              priority: item.priority || 'B'
            };

            if (existingIndex > -1) {
              updatedData[existingIndex] = newItem;
              updateCount++;
            } else {
              updatedData.push(newItem);
              addCount++;
            }
          });

          saveData(updatedData);
          renderTable();
          alert(`å¯¼å…¥å®Œæˆï¼\næ–°å¢ ${addCount} æ¡ï¼Œè¦†ç›– ${updateCount} æ¡`);

        } catch (err) {
          alert('è§£æ JSON æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚');
          console.error(err);
        }
      };
      reader.readAsText(file);
      event.target.value = ''; // å…è®¸é‡å¤å¯¼å…¥
    }

    // å·¥å…·å‡½æ•°
    function id(x) { return document.getElementById(x); }
  </script>
</body>
</html>
